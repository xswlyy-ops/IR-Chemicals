<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lab Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: system-ui, -apple-system; background: #f6f8fa; padding: 10px; max-width: 520px; margin: auto; }
        .section { background: #fff; border-radius: 8px; padding: 10px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
        #reader { width: 100%; min-height: 260px; background: #000; border-radius: 8px; overflow: hidden; }
        h3 { margin: 15px 0 10px; font-size: 18px; }
        label { font-weight: 600; margin-top: 10px; display: block; font-size: 14px; }
        input { width: 100%; padding: 10px; margin-top: 4px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 10px; font-size: 14px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .primary { background: #2da44e; color: white; }
        .secondary { background: #0969da; color: white; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; background: white; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #f0f2f4; }
    </style>
</head>
<body>

<h3>ğŸ“¦ Lab Inventory Scanner</h3>

<div id="reader"></div>
<button class="secondary" onclick="switchCamera()">ğŸ” åˆ‡æ¢æ‘„åƒå¤´</button>

<label>æ¡ç ç¼–å· (Code)</label>
<input id="codeInput" placeholder="æ‰«æåè‡ªåŠ¨å¡«å…¥">

<label>åç§° (Name)</label>
<input id="nameInput" placeholder="è¯·è¾“å…¥è¯å“æˆ–æ ·æœ¬åç§°">

<label>ä½ç½® (Location)</label>
<input id="locationInput" placeholder="ä¾‹å¦‚ï¼šBrdg-Shelf-A1">

<button class="primary" onclick="addRecord()">â• æ·»åŠ è®°å½•</button>
<button style="background:#6e7681; color:white;" onclick="exportCSV()">ğŸ’¾ å¯¼å‡º CSV</button>

<h3>å½“å‰è®°å½• (Today's Records)</h3>
<table id="recordTable">
    <thead>
        <tr>
            <th>æ¡ç </th>
            <th>åç§°</th>
            <th>ä½ç½®</th>
            <th>æ—¶é—´</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    // å˜é‡å®šä¹‰
    const codeInput = document.getElementById("codeInput");
    const nameInput = document.getElementById("nameInput");
    const locationInput = document.getElementById("locationInput");
    const records = [];
    const html5QrCode = new Html5Qrcode("reader");
    let facingMode = "environment";

    // å¯åŠ¨æ‰«æä»ª
    function startScanner() {
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 150 }, // é’ˆå¯¹æ¡å½¢ç ä¼˜åŒ–
            aspectRatio: 1.0
        };

        html5QrCode.start(
            { facingMode: facingMode }, 
            config,
            (decodedText) => {
                codeInput.value = decodedText;
                // æ‰«ææˆåŠŸåéœ‡åŠ¨åé¦ˆ (éƒ¨åˆ†æ‰‹æœºæ”¯æŒ)
                if (navigator.vibrate) navigator.vibrate(100);
            },
            (errorMessage) => { /* å¿½ç•¥æ‰«æä¸­çš„æŠ¥é”™ */ }
        ).catch(err => console.error("å¯åŠ¨å¤±è´¥", err));
    }

    // åˆ‡æ¢æ‘„åƒå¤´
    function switchCamera() {
        html5QrCode.stop().then(() => {
            facingMode = facingMode === "environment" ? "user" : "environment";
            startScanner();
        }).catch(err => console.error(err));
    }

    // æ·»åŠ è®°å½•é€»è¾‘
    function addRecord() {
        const code = codeInput.value.trim();
        const name = nameInput.value.trim();
        const location = locationInput.value.trim();
        const time = new Date().toLocaleTimeString();

        if (!code || !name) {
            alert("è¯·è‡³å°‘å¡«å†™ç¼–å·å’Œåç§°");
            return;
        }

        const record = { code, name, location, time };
        records.push(record);
        
        const row = document.querySelector("#recordTable tbody").insertRow(0); // æ–°è®°å½•åœ¨æœ€å‰
        row.innerHTML = `<td>${code}</td><td>${name}</td><td>${location}</td><td>${time}</td>`;

        // æ¸…ç©ºè¾“å…¥æ–¹ä¾¿ä¸‹æ¬¡æ‰«æ
        codeInput.value = "";
        nameInput.value = "";
    }

    // å¯¼å‡º CSV
    function exportCSV() {
        if (records.length === 0) return alert("æš‚æ— æ•°æ®");
        let csv = "\uFEFFç¼–å·,åç§°,ä½ç½®,æ—¶é—´\n"; // æ·»åŠ BOMé˜²æ­¢Excelä¸­æ–‡ä¹±ç 
        records.forEach(r => {
            csv += `"${r.code}","${r.name}","${r.location}","${r.time}"\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Lab_Scan_${new Date().getTime()}.csv`;
        link.click();
    }

    // åˆå§‹åŒ–
    startScanner();
</script>
</body>
</html>
